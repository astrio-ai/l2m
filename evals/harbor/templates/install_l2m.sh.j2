#!/bin/bash
# Installation script for L2M agent in Harbor container
# This template will be rendered and executed in the container

set -e

echo "Installing L2M (Legacy2Modern) agent..."

# Install git if needed (required for git+https:// installs)
if ! command -v git &> /dev/null; then
    echo "Installing git..."
    apt-get update && apt-get install -y git
fi

# Install Python dependencies if needed
if ! command -v pip &> /dev/null; then
    echo "Installing pip..."
    python3 -m ensurepip --upgrade || apt-get update && apt-get install -y python3-pip
fi

# Install L2M from source or PyPI
# Note: Ubuntu 24.04+ has PEP 668 (externally-managed-environment), so we need --break-system-packages
{% if l2m_install_method == "pypi" %}
# Install from PyPI (when published)
pip install --break-system-packages l2m
{% elif l2m_install_method == "local" %}
# Install from local source
# Assumes L2M source is mounted or copied into the container at /l2m
if [ -d "/l2m" ]; then
    cd /l2m
    pip install --break-system-packages -e .
elif [ -d "/opt/l2m" ]; then
    cd /opt/l2m
    pip install --break-system-packages -e .
else
    echo "Error: L2M source not found. Please mount L2M source to /l2m or /opt/l2m"
    exit 1
fi
{% else %}
# Install from git repository (default)
# This is the most reliable method when source is not mounted
pip install --break-system-packages git+https://github.com/astrio-ai/l2m.git
{% endif %}

# Verify installation
if command -v l2m &> /dev/null; then
    echo "L2M installed successfully"
    l2m --version || echo "Version check failed (may be normal)"
else
    echo "Error: L2M installation failed"
    exit 1
fi

# Set up environment variables if needed
{% if openai_api_key %}
export OPENAI_API_KEY="{{ openai_api_key }}"
{% endif %}
{% if anthropic_api_key %}
export ANTHROPIC_API_KEY="{{ anthropic_api_key }}"
{% endif %}
{% if google_api_key %}
export GOOGLE_API_KEY="{{ google_api_key }}"
{% endif %}

echo "L2M agent setup complete"

